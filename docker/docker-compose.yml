services:
  basekit:
    container_name: open_agbot_basekit
    image: agroecology/open_agbot:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile
    restart: always
    network_mode: host
    ipc: host
    privileged: true
    volumes:
      # Mount the source code for live development
      - ../:/workspace
      # Prevent the container from writing root-owned files to your host's 
      # build/install folders by using named volumes (Optional but cleaner)
      # - build_data:/workspace/build
      # - install_data:/workspace/install
    environment:
      - DISPLAY=${DISPLAY}
      - ROS_DOMAIN_ID=0
      - PYTHONUNBUFFERED=1
    devices:
      - /dev/ttyACM0:/dev/ttyACM0
      - /dev/ttyACM1:/dev/ttyACM1
    # This command checks if the build exists before launching
    command: >
      /bin/bash -c "
      source /opt/ros/humble/setup.bash &&
      if [ ! -f '/workspace/install/setup.bash' ]; then
        echo 'ðŸ›‘ Brain (install folder) not found! You must run the build script first.';
        sleep infinity;
      else
        source /workspace/install/setup.bash &&
        ros2 launch basekit_launch basekit.launch.py
      fi"

# volumes:
#   build_data:
#   install_data:
