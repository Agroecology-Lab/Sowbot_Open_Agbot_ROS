# ==========================================
# STAGE 1: Dependency & Build Layer
# ==========================================
FROM ros:humble-ros-base AS builder

ENV DEBIAN_FRONTEND=noninteractive
ENV PIP_BREAK_SYSTEM_PACKAGES=1

WORKDIR /open_agbot_ws

# 1. Install System Tools
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates curl wget gnupg2 unzip git python3-pip python3-setuptools \
    && curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg

# 2. Heavy Dependencies (With Retry & Fix-Broken)
RUN for i in {1..5}; do \
    curl -fsSL https://www.mongodb.org/static/pgp/server-6.0.asc | \
    gpg --dearmor --yes -o /usr/share/keyrings/mongodb-server-6.0.gpg && \
    echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-6.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/6.0 multiverse" | \
    tee /etc/apt/sources.list.d/mongodb-org-6.0.list && \
    apt-get update && \
    apt-get install -y -f && \
    apt-get install -y --fix-missing --no-install-recommends \
    mongodb-org-server mongodb-org-shell python3-pymongo \
    python3-serial udev libasio-dev python3-colcon-common-extensions \
    libgeographic-dev libpcap0.8-dev python3-transforms3d \
    ros-humble-map-msgs \
    ros-humble-navigation2 ros-humble-nav2-msgs ros-humble-gps-msgs \
    ros-humble-nmea-msgs ros-humble-ublox-msgs ros-humble-ublox-serialization \
    ros-humble-rtcm-msgs ros-humble-diagnostic-updater \
    python3-rosdep && \
    break || (echo "Retry $i/5 failing..." && sleep 10); \
    done

# 3. Python UI & Lizard Firmware
RUN python3 -m pip install --no-cache-dir --upgrade pip && \
    python3 -m pip install --no-cache-dir nicegui lizard && \
    mkdir -p /root/.lizard && cd /root && \
    LATEST_TAG=$(curl -s https://api.github.com/repos/zauberzeug/lizard/releases/latest | grep -oP '"tag_name": "\K(.*)(?=")') && \
    wget -q -O lizard.zip "https://github.com/zauberzeug/lizard/releases/download/${LATEST_TAG}/lizard_firmware_and_devtools_${LATEST_TAG}_esp32.zip" && \
    unzip -qo lizard.zip -d /root/.lizard && rm lizard.zip

# 4. Copy Source & Rosdep
COPY src ./src
RUN apt-get update && apt-get install -y -f && \
    if [ ! -d /etc/ros/rosdep/sources.list.d/ ]; then rosdep init; fi && \
    rosdep update && \
    rosdep install --from-paths src --ignore-src -r -y \
    --skip-keys "pyserial nicegui lizard transforms3d"

# 5. Build
RUN . /opt/ros/humble/setup.sh && \
    colcon build --symlink-install --executor sequential --parallel-workers 1

# ==========================================
# STAGE 2: Development Runtime
# ==========================================
FROM ros:humble-ros-base
WORKDIR /open_agbot_ws

ENV PIP_BREAK_SYSTEM_PACKAGES=1
ENV RMW_IMPLEMENTATION=rmw_cyclonedds_cpp

# Copy Build Artifacts
COPY --from=builder /open_agbot_ws/install ./install
COPY --from=builder /root/.lizard /root/.lizard
COPY --from=builder /usr/local/lib/python3.10/dist-packages /usr/local/lib/python3.10/dist-packages

# FIX: Re-add MongoDB repo in Stage 2 so the shell can be found
RUN apt-get update && apt-get install -y curl gnupg2 && \
    curl -fsSL https://www.mongodb.org/static/pgp/server-6.0.asc | \
    gpg --dearmor --yes -o /usr/share/keyrings/mongodb-server-6.0.gpg && \
    echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-6.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/6.0 multiverse" | \
    tee /etc/apt/sources.list.d/mongodb-org-6.0.list && \
    apt-get update && apt-get install -y --no-install-recommends \
    python3-pip python3-serial udev mongodb-org-shell \
    && rm -rf /var/lib/apt/lists/*
    
# Inside STAGE 2: Development Runtime
RUN apt-get update -o Acquire::AllowInsecureRepositories=true \
    -o Acquire::AllowDowngradeToInsecureRepositories=true && \
    apt-get install -y --allow-unauthenticated --no-install-recommends \
    python3-pip python3-serial udev mongodb-org-shell \
    ros-humble-rmw-cyclonedds-cpp libasio-dev \
    && rm -rf /var/lib/apt/lists/*

 
    
RUN apt-get update -o Acquire::AllowInsecureRepositories=true \
    -o Acquire::AllowDowngradeToInsecureRepositories=true && \
    apt-get install -y --no-install-recommends \
    ros-humble-diagnostic-updater \
    ros-humble-ublox-gps \
    ros-humble-tf-transformations \
    python3-pip python3-serial udev mongodb-org-shell \
    ros-humble-rmw-cyclonedds-cpp libasio-dev \
    && rm -rf /var/lib/apt/lists/*    
    
  
# Environment and Sourcing
ENV PYTHONPATH="/opt/ros/humble/lib/python3.10/site-packages:/open_agbot_ws/install/basekit_ui/lib/python3.10/site-packages:/open_agbot_ws/install/basekit_driver/lib/python3.10/site-packages"
RUN echo "source /opt/ros/humble/setup.bash" >> /root/.bashrc && \
    echo "source /open_agbot_ws/install/setup.bash" >> /root/.bashrc

CMD ["/bin/bash"]
